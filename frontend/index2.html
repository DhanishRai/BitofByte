<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Energy Monitor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Load Flatpickr CSS for Date Range Selection -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <!-- Load Flatpickr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        // Added 'doc' to the Firestore imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, onSnapshot, orderBy, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            setLogLevel('Debug');
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            window.appId = appId; // Attach for easy access

            // Firebase Authentication: Sign in using the custom token or anonymously
            window.initializeAuthAndData = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    window.userId = window.auth.currentUser?.uid || 'anonymous';
                    console.log("Firebase Auth successful. User ID:", window.userId);

                    // Proceed to initialize the dashboard after authentication
                    await window.seedInitialData();
                    window.initializeDatePickers();
                    window.setupRealtimeListener();

                } catch (error) {
                    console.error("Firebase Auth or Init Error:", error);
                    window.showUserMessage('Auth Error', 'Could not connect to Firebase backend. Please check your configuration.', 'text-red-600');
                }
            };
        } else {
             window.showUserMessage('Config Error', 'Firebase configuration is missing. Running in mock data mode.', 'text-red-600');
        }
    </script>

    <style>
        /* Define custom font and color palette */
        :root {
            --color-primary: #10B981; /* Emerald Green */
            --color-secondary: #3B82F6; /* Blue */
            --color-background: #F8F9FA;
            --color-card: #FFFFFF;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: #1F2937; /* Dark Gray for text */
        }
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .shadow-green { box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1), 0 4px 6px -2px rgba(16, 185, 129, 0.05); }

        /* Style for Flatpickr range input */
        .flatpickr-input[readonly] {
            cursor: pointer;
        }

        /* Custom Modal Styling (for error messages) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Custom Modal for Errors (Replaces alert()) -->
    <div id="user-message-modal" class="modal-overlay">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Error</h3>
            <p id="modal-content" class="text-gray-700 mb-4">An unknown error occurred.</p>
            <button onclick="document.getElementById('user-message-modal').style.display='none';" 
                    class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                OK
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Campus Energy Monitor Dashboard
        </h1>
        <p class="text-gray-500 mt-1">
            Actionable insights for a sustainable campus. 
            <span id="auth-status" class="text-xs ml-2 text-gray-400">Loading backend...</span>
        </p>
    </header>

    <!-- Main Dashboard Controls -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-8 border border-gray-100">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Analytics Settings</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

            <!-- Building Selector -->
            <div>
                <label for="building-select" class="block text-sm font-medium text-gray-700 mb-1">Target Building</label>
                <select id="building-select" onchange="updateDashboard()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
                    <option value="LIB">Library (LIB)</option>
                    <option value="DORM">Architecture Block(AB)</option>
                    <option value="ADMIN">Administration (ADMIN)</option>
                    <option value="CAF">Cafeteria (CAF)</option>
                    <option value="SCI">Main block(MB)</option>
                    <option value="GYM">Mechanical Block(MB)</option>
                </select>
            </div>

            <!-- Current Period Selector -->
            <div>
                <label for="date-range-current" class="block text-sm font-medium text-gray-700 mb-1">Current Analysis Period</label>
                <!-- This input will be initialized by flatpickr for date range selection -->
                <input type="text" id="date-range-current" placeholder="Select Date Range" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>

             <!-- Comparison Period Selector -->
            <div>
                <label for="date-range-compare" class="block text-sm font-medium text-gray-700 mb-1">Comparison Baseline Period</label>
                <!-- This input will be initialized by flatpickr for date range selection -->
                <input type="text" id="date-range-compare" placeholder="Select Date Range" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>

            <!-- Action Button -->
            <div class="flex items-end">
                <button onclick="updateDashboard()" class="w-full bg-primary text-white py-2 px-4 rounded-lg font-semibold hover:bg-emerald-600 transition duration-300 ease-in-out shadow-md hover:shadow-lg">
                    Analyze Data
                </button>
            </div>
        </div>
    </div>

    <!-- Analytics KPIs Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Card 1: Total Consumption -->
        <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-primary hover:shadow-lg transition duration-300">
            <p class="text-sm font-medium text-gray-500">Total Consumption (Current)</p>
            <h3 id="kpi-consumption" class="text-3xl font-bold mt-1 text-gray-900">0 kWh</h3>
            <div class="flex items-center text-sm mt-2">
                <span id="kpi-consumption-change" class="text-gray-500 font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8" /></svg>
                    +0%
                </span>
                <span class="text-gray-500 ml-1"> vs. previous period</span>
            </div>
        </div>

        <!-- Card 2: Estimated Cost -->
        <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-blue-500 hover:shadow-lg transition duration-300">
            <p class="text-sm font-medium text-gray-500">Estimated Energy Cost</p>
            <h3 id="kpi-cost" class="text-3xl font-bold mt-1 text-blue-700">₹0.00</h3>
            <div class="flex items-center text-sm mt-2">
                <span id="kpi-cost-change" class="text-gray-500 font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8" /></svg>
                    +0%
                </span>
                <span class="text-gray-500 ml-1"> vs. previous period</span>
            </div>
        </div>

        <!-- Card 3: Carbon Footprint -->
        <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-gray-500 hover:shadow-lg transition duration-300">
            <p class="text-sm font-medium text-gray-500">Carbon Footprint (tCO2e)</p>
            <h3 id="kpi-carbon" class="text-3xl font-bold mt-1 text-gray-700">0.0 tCO2e</h3>
            <div class="flex items-center text-sm mt-2">
                <span id="kpi-carbon-change" class="text-gray-500 font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8" /></svg>
                    +0%
                </span>
                <span class="text-gray-500 ml-1"> vs. previous period</span>
            </div>
        </div>

        <!-- Card 4: Savings Potential -->
        <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-yellow-500 hover:shadow-lg transition duration-300">
            <p class="text-sm font-medium text-gray-500">Potential Annual Savings</p>
            <h3 id="kpi-savings" class="text-3xl font-bold mt-1 text-yellow-700">₹0.00</h3>
            <div class="flex items-center text-sm mt-2 text-green-600 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                </svg>
                <span id="kpi-savings-note">High potential</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area: Chart and Insights -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Column 1 & 2: TWO Charts (now occupying the space of the old single chart) -->
        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Graph 1: Time Series Comparison -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Time-Series Power Comparison (kW)</h2>
                <div class="relative h-80 md:h-96">
                    <canvas id="consumptionChart"></canvas>
                </div>
                <p id="data-count-info" class="text-sm text-gray-500 mt-2">Data points loaded: 0</p>
            </div>

            <!-- Graph 2: Anomaly Spike Details (Bar Chart) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 id="anomaly-chart-title" class="text-xl font-semibold mb-4 text-red-700">Top Anomaly Spike Details (kW)</h2>
                <div class="relative h-80 md:h-96">
                    <canvas id="anomalyChart"></canvas>
                </div>
                <p id="anomaly-chart-info" class="text-sm text-gray-500 mt-2">Highlights the power consumption during specific high-waste events.</p>
            </div>
        </div>
        
        <!-- Column 3: Anomalies and Recommendations -->
        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-100">
                <h2 class="text-xl font-semibold text-red-600 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Waste & Anomalies Detected
                </h2>
                <div id="anomaly-list" class="space-y-3">
                    <!-- Anomalies will be inserted here -->
                </div>
                <div id="no-anomaly" class="text-gray-500 text-sm italic mt-2 hidden">No significant anomalies detected for this period.</div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-semibold text-primary mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m13.364 1.636l-.707-.707M6.343 17l-.707.707M12 20.94V21m-4.673-1.673l-.707.707M17 12a5 5 0 11-10 0 5 5 0 0110 0z" />
                    </svg>
                    Actionable Recommendations
                </h2>
                <ul id="recommendation-list" class="space-y-3 list-disc list-inside text-gray-700 text-sm">
                    <!-- Recommendations will be inserted here -->
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // FIX: Added 'orderBy' to the Firestore imports in the second script block
        import { getFirestore, collection, query, where, getDocs, doc, onSnapshot, writeBatch, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const BUILDING_DATA = {
            LIB: { name: "Library", baseConsumption: 80, peakConsumption: 250, nighttimeWasteFactor: 0.25, maxThreshold: 200, schedule: { start: 8, end: 22 } },
            DORM: { name: "Student Dorm", baseConsumption: 60, peakConsumption: 180, nighttimeWasteFactor: 0.15, maxThreshold: 150, schedule: { start: 0, end: 24 } },
            ADMIN: { name: "Administration", baseConsumption: 40, peakConsumption: 150, nighttimeWasteFactor: 0.4, maxThreshold: 100, schedule: { start: 7, end: 18 } },
            CAF: { name: "Cafeteria", baseConsumption: 50, peakConsumption: 200, nighttimeWasteFactor: 0.3, maxThreshold: 160, schedule: { start: 6, end: 20 } },
            SCI: { name: "Science Block", baseConsumption: 110, peakConsumption: 300, nighttimeWasteFactor: 0.35, maxThreshold: 250, schedule: { start: 7, end: 21 } },
            GYM: { name: "Gymnasium", baseConsumption: 70, peakConsumption: 220, nighttimeWasteFactor: 0.1, maxThreshold: 180, schedule: { start: 6, end: 23 } },
        };
        
        // --- CURRENCY (INR) ---
        const COST_PER_KWH = 8.5; // INR (Approximate cost in India)
        const CARBON_FACTOR_KWH = 0.00045; // Metric tons CO2e per kWh
        
        let consumptionChart = null;
        let anomalyChart = null; // NEW: Chart instance for the anomaly bar graph
        let flatpickrCurrent; // Defined here (global scope)
        let flatpickrCompare; // Defined here (global scope)
        let unsubscribeSnapshot = null;
        let allEnergyData = []; // Store all fetched data globally
        
        // Expose function globally for the import script to call
        window.showUserMessage = (title, message, titleClass = 'text-blue-600') => {
            const modal = document.getElementById('user-message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').className = `text-xl font-bold mb-3 ${titleClass}`;
            document.getElementById('modal-content').textContent = message;
            modal.style.display = 'flex';
        }

        // --- FIREBASE DATA SEEDING (Replaces mock data generation) ---

        /**
         * Generates a single mock data point for a specific building/time.
         */
        function generateSingleReading(buildingId, timestamp, includeAnomaly = false) {
            const config = BUILDING_DATA[buildingId];
            const hour = timestamp.getHours();
            let power_kw;

            let usage = config.baseConsumption + (Math.random() * 10);
            
            if (hour >= config.schedule.start && hour < config.schedule.end) {
                const operatingHours = config.schedule.end - config.schedule.start;
                const normalizedHour = operatingHours > 0 ? (hour - config.schedule.start) / operatingHours : 0.5;
                const peakFactor = Math.sin(normalizedHour * Math.PI) * 0.7 + 0.3;
                usage += (config.peakConsumption - config.baseConsumption) * peakFactor * (0.8 + Math.random() * 0.4);
            }

            power_kw = Math.round(usage * 10) / 10;
            
            if (includeAnomaly && hour >= 1 && hour <= 5) {
                power_kw = Math.max(power_kw, config.maxThreshold * (1 + Math.random() * 0.2));
            }

            return {
                buildingId: buildingId,
                timestamp: Timestamp.fromDate(timestamp), // Store as Firestore Timestamp
                power_kw: power_kw,
                cost: power_kw * COST_PER_KWH,
                carbon: power_kw * CARBON_FACTOR_KWH,
            };
        }

        /**
         * Seeds initial data into Firestore if the collection is empty.
         */
        window.seedInitialData = async () => {
            if (!window.db) return;

            const collectionPath = `/artifacts/${window.appId}/public/data/energy_readings`;
            const collectionRef = collection(window.db, collectionPath); // Define collection reference
            const q = query(collectionRef);
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                // Use 'let' because we reassign 'batch' inside the loop
                let batch = writeBatch(window.db); 
                const endDate = new Date();
                const startDate = new Date(endDate.getTime() - (30 * 24 * 60 * 60 * 1000)); // 30 days ago
                const hoursInPeriod = Math.round((endDate.getTime() - startDate.getTime()) / (3600 * 1000));
                
                console.log("Seeding initial 30 days of data...");
                
                for (let i = 0; i <= hoursInPeriod; i++) {
                    const timestamp = new Date(startDate.getTime() + (i * 3600 * 1000));
                    if (timestamp.getTime() > endDate.getTime()) break;

                    // Generate a reading for the LIB building, adding an anomaly once every 5 days (120 hours)
                    const isAnomalyDay = (i % 120 === 0 && i > 0);
                    const reading = generateSingleReading('LIB', timestamp, isAnomalyDay);
                    
                    // FIX: Use doc(collectionRef) to get a document reference with an auto-generated ID
                    // Then use batch.set() to add the data to the batch.
                    const newDocRef = doc(collectionRef);
                    batch.set(newDocRef, reading);

                    if (i % 50 === 0) { // Commit batch periodically
                        await batch.commit();
                        console.log(`...committed batch up to hour ${i}`);
                        batch = writeBatch(window.db); // Reinitialize batch
                    }
                }
                await batch.commit();
                console.log("Database successfully seeded.");
            }
        };

        // --- FIREBASE REALTIME LISTENER ---

        window.setupRealtimeListener = () => {
            if (!window.db) return;

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); // Stop the previous listener if it exists
            }
            
            const collectionPath = `/artifacts/${window.appId}/public/data/energy_readings`;
            // Listen to ALL energy data. We filter the date/building in JS for simplicity.
            const q = query(collection(window.db, collectionPath), orderBy("timestamp"));

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                allEnergyData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Convert Firestore Timestamp back to JavaScript Date object for processing
                    const jsTimestamp = data.timestamp.toDate(); 
                    allEnergyData.push({
                        ...data,
                        timestamp: jsTimestamp,
                        // Convert power_kw to standard float for consistency
                        power_kw: parseFloat(data.power_kw) 
                    });
                });
                
                document.getElementById('auth-status').textContent = `User: ${window.userId.substring(0, 8)}... | Data Sync: ${allEnergyData.length} points`;
                console.log(`Realtime data updated. Total points: ${allEnergyData.length}`);
                
                // Rerender the dashboard with the new data
                window.updateDashboard(); 

            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                showUserMessage('Data Error', `Failed to load energy data: ${error.message}`, 'text-red-600');
            });
        };

        // --- DATA PROCESSING AND FILTERING ---

        /**
         * Filters the global energy data based on a date range and building ID.
         * @returns {Object} { currentData: Array, compareData: Array }
         */
        function filterDataByDates(buildingId, currentStart, currentEnd, compareStart, compareEnd) {
            
            const currentData = allEnergyData.filter(item => 
                item.buildingId === buildingId && 
                item.timestamp >= currentStart && 
                item.timestamp <= currentEnd
            );

            // For baseline, we use the same filtering logic but apply it to the comparison period dates
            const compareData = allEnergyData.filter(item => 
                item.buildingId === buildingId && 
                item.timestamp >= compareStart && 
                item.timestamp <= compareEnd
            );
            
            // If compareData is empty, we must generate mock data for a baseline
            if (compareData.length === 0) {
                 console.warn("Comparison data not found in Firestore. Generating mock baseline.");
                 // This function is still needed to create a *comparison baseline* if no historical data exists
                 const hoursInPeriod = Math.round((compareEnd.getTime() - compareStart.getTime()) / (3600 * 1000));
                 for (let i = 0; i <= hoursInPeriod; i++) {
                    const timestamp = new Date(compareStart.getTime() + (i * 3600 * 1000));
                    if (timestamp.getTime() > compareEnd.getTime()) break;
                    const reading = generateSingleReading(buildingId, timestamp, false);
                    compareData.push({...reading, timestamp: reading.timestamp.toDate()});
                }
            }

            return { currentData, compareData };
        }


        /**
         * Simple Anomaly Detection using maxThreshold (since we don't have historical stats in this model)
         */
        function detectAnomalies(currentData, buildingId) {
            const config = BUILDING_DATA[buildingId];
            const anomalies = [];
            
            // For a live dashboard with minimal data, a simple static threshold is safer than IQR
            const maxThreshold = config.maxThreshold; 

            currentData.forEach(item => {
                const itemDate = item.timestamp; // Already a Date object
                const hour = itemDate.getHours();
                
                if (item.power_kw > maxThreshold) {
                    
                    const formattedTime = itemDate.toLocaleTimeString('en-IN', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true
                    });
                    
                    let reason = `Consumption is critically high (${item.power_kw.toFixed(1)} kW), exceeding the safe threshold of ${maxThreshold} kW.`;
                    
                    if (hour >= 1 && hour <= 5) {
                        reason += " This is a deep night spike, suggesting equipment failure or wasted energy.";
                    } else if (hour < 7 || hour > 22) {
                        reason += " Occurs outside standard operation, likely a scheduling/timer failure.";
                    }
                    
                    anomalies.push({
                        timestampString: formattedTime, 
                        powerString: item.power_kw.toFixed(1), 
                        timestamp: item.timestamp.toISOString(), 
                        power: item.power_kw, 
                        reason: reason
                    });
                }
            });
            return anomalies;
        }
        
        // --- Data Formatting ---

        /**
         * Converts a raw consumption value (kW) to a formatted currency string.
         */
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(value);
        };
        
        /**
         * Generates recommendations based on detected anomalies and building type.
         */
        function generateRecommendations(anomalies, buildingId, totalDays) {
            const config = BUILDING_DATA[buildingId];
            const recommendations = new Set();
            const buildingName = config.name;

            // General recommendations
            recommendations.add(`Review all ${buildingName} operational schedules (HVAC, pumps, ventilation) against detected anomaly timestamps.`);
            recommendations.add('Conduct an immediate inspection of equipment contributing to the base load during off-hours.');

            if (anomalies.length > 0) {
                recommendations.add(`**Immediate Action:** Address the ${anomalies.length} critical consumption spikes above ${config.maxThreshold} kW.`);
            }

            // High-level cost saving estimate
            // Use a safe estimated average saving per anomaly event.
            const estimatedKWH = anomalies.length * 50; 
            const annualSavings = (estimatedKWH * COST_PER_KWH * (365 / totalDays)).toFixed(2);
            document.getElementById('kpi-savings').textContent = formatCurrency(annualSavings);
            document.getElementById('kpi-savings-note').textContent = `Targeting Waste could save ${formatCurrency(annualSavings)}/yr.`;

            return Array.from(recommendations);
        }

        /**
         * Initializes and updates the Chart.js visualization (Time Series Line Chart).
         * NOTE: This function no longer plots anomalies.
         */
        function renderChart(currentData, compareData, maxThreshold) {
            const ctx = document.getElementById('consumptionChart').getContext('2d');
            
            const currentLabels = currentData.map(d => d.timestamp);
            const currentPower = currentData.map(d => d.power_kw);
            const comparePower = compareData.map(d => d.power_kw);

            // Static Max Threshold line for visualization
            const thresholdData = currentData.map(() => maxThreshold);

            const datasets = [
                {
                    label: 'Current Consumption',
                    data: currentPower,
                    backgroundColor: 'rgba(16, 185, 129, 0.4)',
                    borderColor: 'rgb(16, 185, 129)',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Max Threshold',
                    data: thresholdData,
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.4,
                    borderDash: [8, 4],
                    fill: false
                },
                {
                    label: 'Comparison Baseline',
                    data: comparePower,
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    borderDash: [5, 5],
                    fill: false
                }
            ];

            if (consumptionChart) {
                consumptionChart.destroy();
            }

            consumptionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // TRADING CHART INTERACTION SETTINGS
                    interaction: {
                        mode: 'index', 
                        intersect: false, 
                        axis: 'x' 
                    },
                    hover: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: { 
                                    hour: 'HH:mm',
                                    day: 'MMM d'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date & Time'
                            },
                            grid: { display: false }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Power Consumption (kW)'
                            },
                            min: 0,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        },
                        // PROFESSIONAL TOOLTIP CALLBACKS
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: (context) => {
                                    // Custom Title: Show full date and time clearly
                                    if (context.length > 0) {
                                        return new Date(context[0].label).toLocaleTimeString('en-IN', { 
                                            year: 'numeric', month: 'short', day: 'numeric', 
                                            hour: '2-digit', minute: '2-digit', hour12: false 
                                        });
                                    }
                                    return '';
                                },
                                label: (context) => {
                                    const value = context.parsed.y;
                                    const datasetLabel = context.dataset.label;
                                    
                                    if (datasetLabel.includes('Current Consumption')) {
                                        // Find the raw data point to get cost/carbon if the chart is indexed correctly
                                        const date = new Date(context.label);
                                        const rawDataPoint = currentData.find(d => d.timestamp.getTime() === date.getTime());
                                        
                                        const hourlyCost = rawDataPoint ? rawDataPoint.cost : value * COST_PER_KWH;
                                        const hourlyCarbon = rawDataPoint ? rawDataPoint.carbon : value * CARBON_FACTOR_KWH;
                                        
                                        return [
                                            ` Power: ${value.toFixed(1)} kW`,
                                            ` Est. Cost: ${formatCurrency(hourlyCost)}/hr`,
                                            ` Carbon: ${hourlyCarbon.toFixed(3)} tCO2e/hr`
                                        ];
                                    }

                                    // Default labels for Baseline and Threshold lines
                                    return ` ${datasetLabel}: ${value.toFixed(1)} kW`;
                                }
                            }
                        }
                        // END PROFESSIONAL TOOLTIP CALLBACKS
                    }
                }
            });
        }
        
        /**
         * Initializes and updates the Anomaly Spike Bar Chart.
         */
        function renderAnomalyChart(anomalies, maxThreshold) {
            const ctx = document.getElementById('anomalyChart').getContext('2d');
            
            // Sort and limit anomalies to top 10 for bar chart visualization
            const topAnomalies = anomalies
                .sort((a, b) => b.power - a.power)
                .slice(0, 10);
                
            const chartData = topAnomalies.map(a => a.power);
            const chartLabels = topAnomalies.map(a => a.timestampString);
            
            // Calculate the 'excess' power (power above the maxThreshold)
            const excessPower = topAnomalies.map(a => Math.max(0, a.power - maxThreshold));
            
            document.getElementById('anomaly-chart-title').textContent = 
                topAnomalies.length > 0 ? `Top ${topAnomalies.length} Anomaly Spike Details (kW)` : "No Anomalies Detected";
                
            document.getElementById('anomaly-chart-info').textContent =
                topAnomalies.length > 0 ? `Showing power (kW) for the peak ${topAnomalies.length} spikes detected.` : `No critical spikes found in the current period.`;


            if (anomalyChart) {
                anomalyChart.destroy();
            }
            
            anomalyChart = new Chart(ctx, {
                type: 'bar', // Primary type
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: `Total Spike Power (kW)`,
                            data: chartData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 1,
                        },
                        {
                            label: `Excess Power Above ${maxThreshold} kW`,
                            data: excessPower,
                            type: 'line',
                            borderColor: 'rgb(250, 152, 117)',
                            backgroundColor: 'rgb(250, 152, 117)',
                            pointRadius: 4,
                            pointStyle: 'crossRot',
                            borderWidth: 2,
                            tension: 0.2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Time of Spike' },
                            // Set as category axis
                            type: 'category' 
                        },
                        y: {
                            title: { display: true, text: 'Power (kW)' },
                            beginAtZero: true
                        },
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    if (label.includes(`Excess Power`)) {
                                        return ` Excess: ${context.parsed.y.toFixed(1)} kW`;
                                    }
                                    return `${label}: ${context.parsed.y.toFixed(1)} kW`;
                                }
                            }
                        }
                    }
                }
            });
        }


        /**
         * Calculates KPI metrics and updates the dashboard cards.
         */
        function updateKPIs(currentData, compareData) {
            const currentTotalKwh = currentData.reduce((sum, item) => sum + item.power_kw, 0);
            const compareTotalKwh = compareData.reduce((sum, item) => sum + item.power_kw, 0);

            // 1. Consumption Calculations
            const currentCost = currentTotalKwh * COST_PER_KWH;
            const currentCarbon = currentTotalKwh * CARBON_FACTOR_KWH;
            
            // Handle division by zero
            let changePercent = 0;
            if (compareTotalKwh > 0) {
                changePercent = ((currentTotalKwh - compareTotalKwh) / compareTotalKwh) * 100;
            }
            
            const isIncrease = changePercent > 0;

            const formatChange = () => {
                const element = document.createElement('span');
                element.className = `font-semibold flex items-center`;
                const icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="${isIncrease ? 'M13 7h8m0 0v8m0-8l-8 8' : 'M13 17h8m0 0V9m0 8l-8-8'}" /></svg>`;
                element.innerHTML = `${icon} ${Math.abs(changePercent).toFixed(1)}%`;
                element.classList.add(isIncrease ? 'text-red-500' : 'text-green-500');
                return element;
            };

            // Update Consumption
            document.getElementById('kpi-consumption').textContent = `${currentTotalKwh.toFixed(0)} kWh`;
            document.getElementById('kpi-consumption-change').innerHTML = '';
            document.getElementById('kpi-consumption-change').appendChild(formatChange());
            
            // Update Cost
            document.getElementById('kpi-cost').textContent = formatCurrency(currentCost);
            document.getElementById('kpi-cost-change').innerHTML = '';
            document.getElementById('kpi-cost-change').appendChild(formatChange());

            // Update Carbon
            document.getElementById('kpi-carbon').textContent = `${currentCarbon.toFixed(2)} tCO2e`;
            document.getElementById('kpi-carbon-change').innerHTML = '';
            document.getElementById('kpi-carbon-change').appendChild(formatChange());
            
            document.getElementById('data-count-info').textContent = `Data points loaded in analysis: ${currentData.length}`;
        }

        /**
         * Updates the Anomalies and Recommendations section.
         */
        function updateInsights(anomalies, recommendations) {
            const anomalyList = document.getElementById('anomaly-list');
            const recommendationList = document.getElementById('recommendation-list');
            const noAnomaly = document.getElementById('no-anomaly');

            // Clear previous content
            anomalyList.innerHTML = '';
            recommendationList.innerHTML = '';
            noAnomaly.classList.add('hidden');

            if (anomalies.length > 0) {
                anomalies.slice(0, 5).forEach(a => { // Show top 5 anomalies
                    const li = document.createElement('div');
                    li.className = 'p-3 bg-red-50 border border-red-200 rounded-lg text-sm';
                    li.innerHTML = `
                        <p class="font-bold text-red-700">${a.timestampString}</p>
                        <p class="text-gray-700">Power: <span class="font-mono text-red-600">${a.powerString} kW</span></p>
                        <p class="text-gray-600 mt-1">${a.reason}</p>
                    `;
                    anomalyList.appendChild(li);
                });
                if (anomalies.length > 5) {
                     anomalyList.innerHTML += `<p class="text-xs text-center text-gray-500 mt-2">... and ${anomalies.length - 5} more critical alerts detected.</p>`;
                }
            } else {
                noAnomaly.classList.remove('hidden');
            }

            recommendations.forEach(r => {
                const li = document.createElement('li');
                li.className = 'text-gray-700';
                li.textContent = r;
                recommendationList.appendChild(li);
            });
        }


        /**
         * Main function to filter data and update all dashboard components.
         */
        window.updateDashboard = () => {
            // FIX: Check if flatpickr instances are initialized before accessing selectedDates
            if (!flatpickrCurrent || !flatpickrCompare) {
                // If this function is called too early (e.g., via button click before onload finishes), safely exit.
                console.warn("Flatpickr instances not yet initialized. Skipping dashboard update.");
                return; 
            }
            
            const buildingId = document.getElementById('building-select').value;
            
            const currentPeriod = flatpickrCurrent.selectedDates;
            const comparePeriod = flatpickrCompare.selectedDates;

            // Date Range Validation
            if (currentPeriod.length < 2 || comparePeriod.length < 2) {
                // Do not show an error here if data is still loading
                if (allEnergyData.length === 0) return;
                showUserMessage('Input Error', 'Please select both the start and end dates for both the Current and Comparison periods.', 'text-red-600');
                return;
            }

            const currentStartDate = currentPeriod[0];
            const currentEndDate = currentPeriod[1];
            const compareStartDate = comparePeriod[0];
            const compareEndDate = comparePeriod[1];
            
            // Calculate total days in current period for annual savings projection
            const currentDurationMs = currentEndDate.getTime() - currentStartDate.getTime();
            const currentDurationDays = currentDurationMs / (1000 * 60 * 60 * 24) || 1;

            // 1. Filter Real-Time Data from Firestore Snapshot
            const { currentData, compareData } = filterDataByDates(
                buildingId, 
                currentStartDate, currentEndDate, 
                compareStartDate, compareEndDate
            );
            
            // 2. Perform Analysis
            const maxThreshold = BUILDING_DATA[buildingId].maxThreshold;
            const anomalies = detectAnomalies(currentData, buildingId); 
            const recommendations = generateRecommendations(anomalies, buildingId, currentDurationDays);
            
            // 3. Render Components
            updateKPIs(currentData, compareData);
            // NOW RENDERING TWO SEPARATE CHARTS
            renderChart(currentData, compareData, maxThreshold); // Line chart
            renderAnomalyChart(anomalies, maxThreshold); // Bar chart
            updateInsights(anomalies, recommendations);

            console.log(`Dashboard updated for ${BUILDING_DATA[buildingId].name}. Current KWh: ${currentData.reduce((sum, item) => sum + item.power_kw, 0).toFixed(0)}`);
        }
        
        // --- Initialization ---
        
        /**
         * Initializes Flatpickr on the date inputs.
         */
        window.initializeDatePickers = () => {
            const today = new Date();
            const currentEnd = new Date(today);
            const currentStart = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000)); // Last 7 days
            const compareEnd = new Date(currentStart.getTime() - (1 * 24 * 60 * 60 * 1000));
            const compareStart = new Date(compareEnd.getTime() - (7 * 24 * 60 * 60 * 1000)); // Previous 7 days

            // Flatpickr setup for Current Period
            flatpickrCurrent = flatpickr("#date-range-current", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [currentStart, currentEnd],
                onClose: window.updateDashboard 
            });

            // Flatpickr setup for Comparison Period
            flatpickrCompare = flatpickr("#date-range-compare", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [compareStart, compareEnd],
                onClose: window.updateDashboard 
            });
        }


        // Start the process: Auth -> Seed (if empty) -> Date Pickers -> Realtime Listener
        window.onload = () => {
            document.getElementById('auth-status').textContent = 'Authenticating...';
            window.initializeAuthAndData();
        };

    </script>
</body>
</html>
